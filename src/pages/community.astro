---
import Layout from '../components/Layout.astro';
---

<Layout title="ä½œå“ç¤¾åŒº - GameCode Lab">
  <div class="min-h-screen bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="sticky top-0 z-40 border-b border-gray-200 bg-white shadow-sm">
      <div class="mx-auto max-w-7xl px-4 py-4">
        <div class="flex items-center justify-between">
          <a href="/" class="flex items-center gap-2 text-xl font-bold text-gray-900">
            <span class="rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 p-2 text-white">
              ğŸ®
            </span>
            GameCode Lab
          </a>
          
          <div class="flex items-center gap-4">
            <a href="/learn" class="text-gray-600 transition hover:text-gray-900">
              å­¦ä¹ ä¸­å¿ƒ
            </a>
            <button
              id="createProjectBtn"
              class="rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 px-4 py-2 text-sm font-semibold text-white transition hover:from-blue-600 hover:to-purple-700"
            >
              âœ¨ å‘å¸ƒä½œå“
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-blue-500 to-purple-600 px-4 py-12 text-white">
      <div class="mx-auto max-w-7xl text-center">
        <h1 class="mb-4 text-4xl font-bold">ğŸ¨ ä½œå“å±•ç¤ºç¤¾åŒº</h1>
        <p class="text-xl text-white/90">
          åˆ†äº«ä½ çš„åˆ›æ„ï¼Œå‘ç°ç²¾å½©ä½œå“ï¼Œä¸å…¨çƒå¼€å‘è€…äº¤æµå­¦ä¹ 
        </p>
      </div>
    </section>

    <!-- ç­›é€‰å’Œæ’åº -->
    <div class="sticky top-[73px] z-30 border-b border-gray-200 bg-white py-4">
      <div class="mx-auto max-w-7xl px-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <!-- æ ‡ç­¾è¿‡æ»¤ -->
          <div class="flex flex-wrap gap-2">
            <button class="rounded-full bg-blue-100 px-4 py-2 text-sm font-medium text-blue-700 transition hover:bg-blue-200">
              å…¨éƒ¨
            </button>
            <button class="rounded-full bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200">
              HTML5
            </button>
            <button class="rounded-full bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200">
              CSS åŠ¨ç”»
            </button>
            <button class="rounded-full bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200">
              JavaScript
            </button>
            <button class="rounded-full bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200">
              æ¸¸æˆ
            </button>
            <button class="rounded-full bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200">
              å·¥å…·
            </button>
          </div>

          <!-- æ’åº -->
          <select
            id="sortSelect"
            class="rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
          >
            <option value="latest">æœ€æ–°å‘å¸ƒ</option>
            <option value="popular">æœ€å—æ¬¢è¿</option>
            <option value="views">æµè§ˆæœ€å¤š</option>
            <option value="ai_score">AI è¯„åˆ†</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ç²¾é€‰ä½œå“è½®æ’­ -->
    <section class="py-8 px-4">
      <div class="mx-auto max-w-7xl">
        <h2 class="mb-6 flex items-center gap-2 text-2xl font-bold text-gray-900">
          <span>â­</span>
          æœ¬å‘¨ç²¾é€‰ä½œå“
        </h2>
        <div id="featuredProjectsContainer" class="grid gap-6 md:grid-cols-3">
          <!-- ç²¾é€‰ä½œå“å¡ç‰‡ -->
        </div>
      </div>
    </section>

    <!-- æ‰€æœ‰ä½œå“ç½‘æ ¼ -->
    <section class="py-8 px-4">
      <div class="mx-auto max-w-7xl">
        <h2 class="mb-6 text-2xl font-bold text-gray-900">
          æ¢ç´¢æ›´å¤šä½œå“
        </h2>
        <div id="projectsContainer" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€åŠ è½½ -->
        </div>

        <!-- åŠ è½½æ›´å¤š -->
        <div class="mt-8 text-center">
          <button
            id="loadMoreBtn"
            class="rounded-lg bg-gray-200 px-6 py-3 font-medium text-gray-700 transition hover:bg-gray-300"
          >
            åŠ è½½æ›´å¤š
          </button>
        </div>
      </div>
    </section>

    <!-- AI æ¯æ—¥æ¨è -->
    <section class="py-8 px-4 bg-gradient-to-br from-purple-50 to-blue-50">
      <div class="mx-auto max-w-7xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="flex items-center gap-2 text-2xl font-bold text-gray-900">
            <span>ğŸ¤–</span>
            AI æ¨èä»Šæ—¥å¿…çœ‹
          </h2>
          <button class="text-sm text-blue-600 hover:text-blue-700">
            æŸ¥çœ‹å…¨éƒ¨ â†’
          </button>
        </div>
        <div id="aiRecommendedContainer" class="grid gap-6 md:grid-cols-2">
          <!-- AI æ¨èä½œå“ -->
        </div>
      </div>
    </section>
  </div>

  <!-- ä½œå“è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="projectModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-black/50 backdrop-blur-sm">
    <div class="flex min-h-screen items-center justify-center p-4">
      <div id="projectModalContent" class="w-full max-w-6xl rounded-2xl bg-white p-8 shadow-2xl">
        <!-- å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
      </div>
    </div>
  </div>
</Layout>

<script>
  // @ts-nocheck
  import { supabase } from '../lib/supabase';

  let currentPage = 1;
  const pageSize = 12;

  // åŠ è½½ä½œå“
  async function loadProjects(page = 1, sortBy = 'latest') {
    const container = document.getElementById('projectsContainer');
    if (!container) return;
    
    try {
      let query = supabase
        .from('user_projects')
        .select('*')
        .eq('is_public', true)
        .range((page - 1) * pageSize, page * pageSize - 1);

      // æ’åº
      switch (sortBy) {
        case 'latest':
          query = query.order('created_at', { ascending: false });
          break;
        case 'popular':
          query = query.order('likes_count', { ascending: false });
          break;
        case 'views':
          query = query.order('views_count', { ascending: false });
          break;
        case 'ai_score':
          query = query.order('ai_score', { ascending: false, nullsFirst: false });
          break;
      }

      const { data: projects, error } = await query;

      if (error) throw error;

      if (projects && projects.length > 0) {
        if (page === 1) {
          container.innerHTML = '';
        }
        
        // ç®€åŒ–ç‰ˆï¼šç›´æ¥æ¸²æŸ“ HTML
        projects.forEach((project) => {
          const projectCard = document.createElement('div');
          projectCard.className = 'rounded-xl border border-gray-200 bg-white p-6 shadow-md transition hover:shadow-lg cursor-pointer';
          projectCard.innerHTML = `
            <h3 class="text-xl font-bold mb-2">${project.title}</h3>
            <p class="text-gray-600 mb-4">${project.description || ''}</p>
            <div class="flex items-center gap-4 text-sm text-gray-500">
              <span>â¤ï¸ ${project.likes_count}</span>
              <span>ğŸ‘ï¸ ${project.views_count}</span>
              <span>ğŸ’¬ ${project.comments_count}</span>
            </div>
          `;
          projectCard.onclick = () => showProjectDetail(project);
          container.appendChild(projectCard);
        });
      }
    } catch (error) {
      console.error('Error loading projects:', error);
    }
  }

  // ç‚¹èµ
  async function handleLike(projectId) {
    console.log('Like project:', projectId);
    alert('ç‚¹èµåŠŸèƒ½å¼€å‘ä¸­...');
  }

  // æ˜¾ç¤ºä½œå“è¯¦æƒ…
  function showProjectDetail(project) {
    const modal = document.getElementById('projectModal');
    const content = document.getElementById('projectModalContent');
    if (!modal || !content) return;

    // å¢åŠ æµè§ˆè®¡æ•°
    supabase.rpc('increment_project_views', { project_id: project.id });

    content.innerHTML = `
      <div class="relative">
        <button
          onclick="document.getElementById('projectModal').classList.add('hidden')"
          class="absolute right-0 top-0 text-gray-400 hover:text-gray-600"
        >
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <div class="mb-6">
          <h2 class="mb-2 text-3xl font-bold text-gray-900">${project.title}</h2>
          ${project.description ? `<p class="text-gray-600">${project.description}</p>` : ''}
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="mb-6 rounded-xl border border-gray-200 bg-white shadow-lg overflow-hidden">
          <div class="text-center p-8 text-gray-500">
            é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...
          </div>
        </div>

        <!-- å…ƒæ•°æ® -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="rounded-lg bg-gray-50 p-4 text-center">
            <div class="mb-1 text-2xl">â¤ï¸</div>
            <div class="text-2xl font-bold text-gray-900">${project.likes_count}</div>
            <div class="text-xs text-gray-500">ç‚¹èµ</div>
          </div>
          <div class="rounded-lg bg-gray-50 p-4 text-center">
            <div class="mb-1 text-2xl">ğŸ‘ï¸</div>
            <div class="text-2xl font-bold text-gray-900">${project.views_count}</div>
            <div class="text-xs text-gray-500">æµè§ˆ</div>
          </div>
          <div class="rounded-lg bg-gray-50 p-4 text-center">
            <div class="mb-1 text-2xl">ğŸ’¬</div>
            <div class="text-2xl font-bold text-gray-900">${project.comments_count}</div>
            <div class="text-xs text-gray-500">è¯„è®º</div>
          </div>
          ${project.ai_score ? `
            <div class="rounded-lg bg-gradient-to-br from-purple-50 to-blue-50 p-4 text-center">
              <div class="mb-1 text-2xl">â­</div>
              <div class="text-2xl font-bold text-purple-600">${project.ai_score}</div>
              <div class="text-xs text-purple-500">AI è¯„åˆ†</div>
            </div>
          ` : ''}
        </div>

        ${project.ai_feedback ? `
          <div class="mb-6 rounded-xl bg-purple-50 p-6 border border-purple-100">
            <h3 class="mb-3 flex items-center gap-2 text-lg font-bold text-purple-900">
              <span>ğŸ¤–</span>
              AI è¯„ä»·
            </h3>
            <p class="text-purple-700">${project.ai_feedback}</p>
          </div>
        ` : ''}

        <!-- æŒ‰é’® -->
        <div class="flex gap-3">
          <button class="flex-1 rounded-lg bg-blue-600 px-6 py-3 font-semibold text-white transition hover:bg-blue-700">
            â¤ï¸ ç‚¹èµ
          </button>
          <button class="flex-1 rounded-lg bg-gray-200 px-6 py-3 font-semibold text-gray-700 transition hover:bg-gray-300">
            ğŸ’¬ è¯„è®º
          </button>
          <button class="rounded-lg bg-gray-200 px-6 py-3 font-semibold text-gray-700 transition hover:bg-gray-300">
            ğŸ”—
          </button>
        </div>
      </div>
    `;

    modal.classList.remove('hidden');
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/"/g, '&quot;');
  }

  // æ’åºåˆ‡æ¢
  document.getElementById('sortSelect')?.addEventListener('change', (e) => {
    const sortBy = (e.target as HTMLSelectElement).value;
    currentPage = 1;
    loadProjects(1, sortBy);
  });

  // åŠ è½½æ›´å¤š
  document.getElementById('loadMoreBtn')?.addEventListener('click', () => {
    currentPage++;
    loadProjects(currentPage);
  });

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    loadProjects(1);
  });
</script>

