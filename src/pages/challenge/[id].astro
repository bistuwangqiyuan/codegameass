---
import Layout from '../../components/Layout.astro';

export const prerender = false;
---

<Layout title="ç¼–ç¨‹æŒ‘æˆ˜ - GameCode Lab">
  <div class="flex h-screen flex-col bg-gray-900">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="flex items-center justify-between border-b border-gray-700 bg-gray-800 px-6 py-3">
      <div class="flex items-center gap-4">
        <a
          href="/learn"
          class="flex items-center gap-2 text-gray-300 transition hover:text-white"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          è¿”å›
        </a>
        
        <div class="h-6 w-px bg-gray-600"></div>
        
        <div>
          <h1 class="text-lg font-bold text-white" id="challengeTitle">åŠ è½½ä¸­...</h1>
          <p class="text-xs text-gray-400" id="challengeType"></p>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <!-- è®¡æ—¶å™¨ -->
        <div class="flex items-center gap-2 rounded-lg bg-gray-700 px-4 py-2 text-white">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span id="timer" class="font-mono">00:00</span>
        </div>

        <!-- å¥–åŠ±ä¿¡æ¯ -->
        <div class="flex items-center gap-3 text-sm">
          <div class="flex items-center gap-1 text-yellow-400">
            <span>â­</span>
            <span id="xpReward">0</span>
            <span class="text-gray-400">XP</span>
          </div>
          <div class="flex items-center gap-1 text-yellow-400">
            <span>ğŸª™</span>
            <span id="coinReward">0</span>
            <span class="text-gray-400">é‡‘å¸</span>
          </div>
        </div>

        <!-- AI åŠ©æ•™æŒ‰é’® -->
        <button
          id="aiHelpBtn"
          class="rounded-lg bg-purple-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-purple-700"
        >
          âœ¨ AI åŠ©æ•™
        </button>

        <!-- æäº¤æŒ‰é’® -->
        <button
          id="submitBtn"
          class="rounded-lg bg-green-600 px-6 py-2 text-sm font-medium text-white transition hover:bg-green-700"
        >
          æäº¤ç­”æ¡ˆ
        </button>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="flex flex-1 overflow-hidden">
      <!-- å·¦ä¾§ï¼šé¢˜ç›®è¯´æ˜ -->
      <div class="w-1/3 overflow-y-auto border-r border-gray-700 bg-gray-800 p-6">
        <!-- éš¾åº¦æ ‡ç­¾ -->
        <div class="mb-4">
          <span id="difficultyBadge" class="rounded-full px-3 py-1 text-xs font-medium"></span>
        </div>

        <!-- é¢˜ç›®æè¿° -->
        <div class="mb-6">
          <h2 class="mb-2 text-lg font-bold text-white">ğŸ“ é¢˜ç›®æè¿°</h2>
          <div id="challengeDescription" class="text-sm text-gray-300"></div>
        </div>

        <!-- å…·ä½“è¦æ±‚ -->
        <div class="mb-6">
          <h2 class="mb-2 text-lg font-bold text-white">âœ… ä»»åŠ¡è¦æ±‚</h2>
          <div id="challengeInstructions" class="text-sm text-gray-300 whitespace-pre-wrap"></div>
        </div>

        <!-- æç¤ºç³»ç»Ÿ -->
        <div class="mb-6">
          <h2 class="mb-2 text-lg font-bold text-white">ğŸ’¡ æç¤º</h2>
          <div id="hintsContainer" class="space-y-2">
            <!-- æç¤ºå°†åŠ¨æ€åŠ è½½ -->
          </div>
          <button
            id="getHintBtn"
            class="mt-3 w-full rounded-lg bg-yellow-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-yellow-700"
          >
            è·å–æç¤º (-5 é‡‘å¸)
          </button>
        </div>

        <!-- æµ‹è¯•ç”¨ä¾‹ -->
        <div>
          <h2 class="mb-2 text-lg font-bold text-white">ğŸ§ª æµ‹è¯•ç”¨ä¾‹</h2>
          <div id="testCasesContainer" class="space-y-2 text-sm text-gray-300">
            <!-- æµ‹è¯•ç”¨ä¾‹å°†åŠ¨æ€åŠ è½½ -->
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šä»£ç ç¼–è¾‘å™¨ -->
      <div class="flex-1">
        <div id="codeEditorContainer" class="h-full"></div>
      </div>
    </div>

    <!-- ç»“æœæ¨¡æ€æ¡† -->
    <div id="resultModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="w-full max-w-lg rounded-2xl bg-white p-8 shadow-2xl">
        <div id="resultContent"></div>
      </div>
    </div>
  </div>

  <!-- AI åŠ©æ•™ -->
  <div id="aiAssistantRoot"></div>
</Layout>

<script>
  // @ts-nocheck
  import { supabase } from '../../lib/supabase';

  // è·å–æŒ‘æˆ˜ ID
  const challengeId = window.location.pathname.split('/').pop();
  let challenge: any = null;
  let startTime = Date.now();
  let timerInterval: number;
  let hintsUsed = 0;

  // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
  const editorContainer = document.getElementById('codeEditorContainer');
  if (editorContainer) {
    const root = createRoot(editorContainer);
    root.render(
      createElement(CodeEditor, {
        challengeId,
        onSave: handleSave,
        onRun: handleRun
      })
    );
  }

  // AI åŠ©æ•™
  const aiAssistantRoot = document.getElementById('aiAssistantRoot');
  let aiOpen = false;
  if (aiAssistantRoot) {
    const root = createRoot(aiAssistantRoot);
    const renderAI = (isOpen: boolean) => {
      root.render(createElement(AIAssistant, {
        isOpen,
        onClose: () => {
          aiOpen = false;
          renderAI(false);
        }
      }));
    };
    
    document.getElementById('aiHelpBtn')?.addEventListener('click', () => {
      aiOpen = true;
      renderAI(true);
    });
    
    renderAI(false);
  }

  // åŠ è½½æŒ‘æˆ˜æ•°æ®
  async function loadChallenge() {
    try {
      const { data, error } = await supabase
        .from('challenges')
        .select('*')
        .eq('id', challengeId)
        .single();

      if (error) throw error;
      challenge = data;

      // æ›´æ–° UI
      document.getElementById('challengeTitle')!.textContent = challenge.title;
      document.getElementById('challengeType')!.textContent = getTypeLabel(challenge.challenge_type);
      document.getElementById('challengeDescription')!.textContent = challenge.description;
      document.getElementById('challengeInstructions')!.textContent = challenge.instructions;
      document.getElementById('xpReward')!.textContent = challenge.xp_reward;
      document.getElementById('coinReward')!.textContent = challenge.coin_reward;

      // éš¾åº¦æ ‡ç­¾
      const difficultyBadge = document.getElementById('difficultyBadge')!;
      const difficultyConfig: any = {
        easy: { label: 'ç®€å•', class: 'bg-green-500 text-white' },
        medium: { label: 'ä¸­ç­‰', class: 'bg-yellow-500 text-white' },
        hard: { label: 'å›°éš¾', class: 'bg-orange-500 text-white' },
        expert: { label: 'ä¸“å®¶', class: 'bg-red-500 text-white' }
      };
      const config = difficultyConfig[challenge.difficulty];
      difficultyBadge.textContent = config.label;
      difficultyBadge.className = `rounded-full px-3 py-1 text-xs font-medium ${config.class}`;

      // è®¾ç½®èµ·å§‹ä»£ç 
      const { setAllCode } = useEditorStore.getState();
      setAllCode({
        html: challenge.starter_html || '',
        css: challenge.starter_css || '',
        js: challenge.starter_js || ''
      });

      // åŠ è½½æç¤ºå’Œæµ‹è¯•ç”¨ä¾‹
      loadHints();
      loadTestCases();

      // å¯åŠ¨è®¡æ—¶å™¨
      startTimer();
    } catch (error) {
      console.error('Error loading challenge:', error);
      alert('åŠ è½½æŒ‘æˆ˜å¤±è´¥');
    }
  }

  function getTypeLabel(type: string): string {
    const labels: any = {
      code_completion: 'ä»£ç è¡¥å…¨',
      bug_fix: 'ä¿®å¤Bug',
      build_from_scratch: 'ä»é›¶æ„å»º',
      quiz: 'çŸ¥è¯†é—®ç­”',
      boss_challenge: 'BossæŒ‘æˆ˜'
    };
    return labels[type] || type;
  }

  function loadHints() {
    if (!challenge.hints || challenge.hints.length === 0) return;
    
    const container = document.getElementById('hintsContainer')!;
    container.innerHTML = '<p class="text-gray-400 text-sm">æš‚æ— å·²è§£é”çš„æç¤º</p>';
  }

  function loadTestCases() {
    if (!challenge.test_cases || challenge.test_cases.length === 0) return;
    
    const container = document.getElementById('testCasesContainer')!;
    container.innerHTML = challenge.test_cases
      .map((tc: any, i: number) => `
        <div class="rounded bg-gray-700 p-2">
          <strong>æµ‹è¯• ${i + 1}:</strong> ${tc.description || 'æ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆè¦æ±‚'}
        </div>
      `)
      .join('');
  }

  function startTimer() {
    timerInterval = window.setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('timer')!.textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
  }

  function handleSave(code: { html: string; css: string; js: string }) {
    // ä¿å­˜è¿›åº¦åˆ°æ•°æ®åº“
    const user = useUserStore.getState().user;
    if (!user) return;

    supabase
      .from('user_challenge_progress')
      .upsert({
        user_id: user.id,
        challenge_id: challengeId,
        last_saved_html: code.html,
        last_saved_css: code.css,
        last_saved_js: code.js,
        last_accessed_at: new Date().toISOString()
      });
  }

  function handleRun() {
    console.log('Running code...');
  }

  // æäº¤ç­”æ¡ˆ
  document.getElementById('submitBtn')?.addEventListener('click', async () => {
    const { html, css, js } = useEditorStore.getState();
    const user = useUserStore.getState().user;
    
    if (!user) {
      alert('è¯·å…ˆç™»å½•');
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.getElementById('submitBtn')!;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'è¯„ä¼°ä¸­...';
    submitBtn.setAttribute('disabled', 'true');

    try {
      // ä½¿ç”¨ AI è¯„ä¼°ä»£ç 
      const result = await evaluateCode(
        { html, css, js },
        {
          title: challenge.title,
          description: challenge.description,
          instructions: challenge.instructions
        }
      );

      if (result.success) {
        showResult(true, result.message);
        
        // è®°å½•å®Œæˆ
        await supabase.from('user_challenge_progress').upsert({
          user_id: user.id,
          challenge_id: challengeId,
          status: 'completed',
          completion_time_seconds: Math.floor((Date.now() - startTime) / 1000),
          hints_used: hintsUsed,
          completed_at: new Date().toISOString()
        });

        // æ·»åŠ å¥–åŠ±
        await supabase.from('xp_transactions').insert({
          user_id: user.id,
          amount: challenge.xp_reward,
          reason: `å®ŒæˆæŒ‘æˆ˜: ${challenge.title}`,
          source_type: 'challenge',
          source_id: challengeId
        });

        await supabase.from('coin_transactions').insert({
          user_id: user.id,
          amount: challenge.coin_reward,
          transaction_type: 'earn',
          reason: `å®ŒæˆæŒ‘æˆ˜: ${challenge.title}`,
          source_type: 'challenge',
          source_id: challengeId
        });
      } else {
        showResult(false, result.error || 'æäº¤å¤±è´¥');
      }
    } catch (error) {
      console.error('Error submitting:', error);
      showResult(false, 'è¯„ä¼°å‡ºé”™ï¼Œè¯·ç¨åå†è¯•');
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.removeAttribute('disabled');
    }
  });

  function showResult(success: boolean, message: string) {
    const modal = document.getElementById('resultModal')!;
    const content = document.getElementById('resultContent')!;
    
    content.innerHTML = `
      <div class="text-center">
        <div class="mb-4 text-6xl">${success ? 'ğŸ‰' : 'ğŸ’ª'}</div>
        <h3 class="mb-2 text-2xl font-bold ${success ? 'text-green-600' : 'text-orange-600'}">
          ${success ? 'æŒ‘æˆ˜æˆåŠŸï¼' : 'å†è¯•ä¸€æ¬¡ï¼'}
        </h3>
        <p class="mb-6 text-gray-600">${message}</p>
        ${success ? `
          <div class="mb-6 flex justify-center gap-4">
            <div class="rounded-lg bg-yellow-50 px-4 py-2">
              <span class="text-yellow-600">â­ +${challenge.xp_reward} XP</span>
            </div>
            <div class="rounded-lg bg-yellow-50 px-4 py-2">
              <span class="text-yellow-600">ğŸª™ +${challenge.coin_reward} é‡‘å¸</span>
            </div>
          </div>
        ` : ''}
        <div class="flex gap-3">
          ${success ? `
            <button onclick="window.location.href='/learn'" class="flex-1 rounded-lg bg-blue-600 px-4 py-2 text-white">
              è¿”å›å­¦ä¹ ä¸­å¿ƒ
            </button>
            <button onclick="location.reload()" class="flex-1 rounded-lg bg-gray-300 px-4 py-2">
              å†ç©ä¸€æ¬¡
            </button>
          ` : `
            <button onclick="document.getElementById('resultModal').classList.add('hidden')" class="flex-1 rounded-lg bg-blue-600 px-4 py-2 text-white">
              ç»§ç»­å°è¯•
            </button>
          `}
        </div>
      </div>
    `;
    
    modal.classList.remove('hidden');
  }

  // è·å–æç¤º
  document.getElementById('getHintBtn')?.addEventListener('click', async () => {
    const user = useUserStore.getState().user;
    if (!user) return;

    if (user.coins < 5) {
      alert('é‡‘å¸ä¸è¶³ï¼å®Œæˆæ›´å¤šæŒ‘æˆ˜æ¥è·å–é‡‘å¸ã€‚');
      return;
    }

    hintsUsed++;
    const { html, css, js } = useEditorStore.getState();
    
    const hint = await generateHint(
      {
        title: challenge.title,
        description: challenge.description,
        instructions: challenge.instructions
      },
      { html, css, js },
      Math.min(hintsUsed, 3)
    );

    if (hint.success) {
      const container = document.getElementById('hintsContainer')!;
      const hintDiv = document.createElement('div');
      hintDiv.className = 'rounded bg-yellow-900/30 border border-yellow-600 p-3 text-sm text-yellow-100';
      hintDiv.innerHTML = `<strong>æç¤º ${hintsUsed}:</strong> ${hint.message}`;
      container.appendChild(hintDiv);

      // æ‰£é™¤é‡‘å¸
      await supabase.from('coin_transactions').insert({
        user_id: user.id,
        amount: -5,
        transaction_type: 'spend',
        reason: 'è·å–æç¤º',
        source_type: 'hint',
        source_id: challengeId
      });
    }
  });

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    loadChallenge();
  });
</script>

