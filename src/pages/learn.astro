---
import Layout from '../components/Layout.astro';
---

<Layout title="å­¦ä¹ ä¸­å¿ƒ - GameCode Lab">
  <div class="min-h-screen bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="sticky top-0 z-40 border-b border-gray-200 bg-white shadow-sm">
      <div class="mx-auto max-w-7xl px-4 py-4">
        <div class="flex items-center justify-between">
          <a href="/" class="flex items-center gap-2 text-xl font-bold text-gray-900">
            <span class="rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 p-2 text-white">
              ğŸ®
            </span>
            GameCode Lab
          </a>
          
          <div class="flex items-center gap-4">
            <button id="aiAssistantBtn" class="flex items-center gap-2 rounded-lg bg-purple-100 px-4 py-2 text-purple-700 transition hover:bg-purple-200">
              <span>âœ¨</span>
              <span class="hidden sm:inline">AI åŠ©æ•™</span>
            </button>
            <div id="userProfileBtn" class="cursor-pointer"></div>
          </div>
        </div>
      </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="mx-auto max-w-7xl px-4 py-8">
      <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
      <div class="mb-8">
        <div id="userProfileCard"></div>
      </div>

      <!-- å­¦ä¹ è¿›åº¦æ¦‚è§ˆ -->
      <div class="mb-8">
        <h2 class="mb-4 text-2xl font-bold text-gray-900">ğŸ“Š å­¦ä¹ æ¦‚è§ˆ</h2>
        <div class="grid gap-6 md:grid-cols-4">
          <div class="rounded-xl bg-white p-6 shadow-md">
            <div class="mb-2 flex items-center gap-2 text-blue-600">
              <span class="text-2xl">ğŸ“š</span>
              <span class="text-sm font-medium">å®Œæˆè¯¾ç¨‹</span>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="completedLessons">0</p>
            <p class="mt-1 text-xs text-gray-500">/ 25 è¯¾ç¨‹</p>
          </div>

          <div class="rounded-xl bg-white p-6 shadow-md">
            <div class="mb-2 flex items-center gap-2 text-green-600">
              <span class="text-2xl">ğŸ¯</span>
              <span class="text-sm font-medium">å®ŒæˆæŒ‘æˆ˜</span>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="completedChallenges">0</p>
            <p class="mt-1 text-xs text-gray-500">/ 50 æŒ‘æˆ˜</p>
          </div>

          <div class="rounded-xl bg-white p-6 shadow-md">
            <div class="mb-2 flex items-center gap-2 text-yellow-600">
              <span class="text-2xl">â­</span>
              <span class="text-sm font-medium">ç»éªŒå€¼</span>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="totalXP">0</p>
            <p class="mt-1 text-xs text-gray-500">XP</p>
          </div>

          <div class="rounded-xl bg-white p-6 shadow-md">
            <div class="mb-2 flex items-center gap-2 text-purple-600">
              <span class="text-2xl">ğŸ†</span>
              <span class="text-sm font-medium">æˆå°±å¾½ç« </span>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="totalAchievements">0</p>
            <p class="mt-1 text-xs text-gray-500">ä¸ªæˆå°±</p>
          </div>
        </div>
      </div>

      <!-- å­¦ä¹ è·¯å¾„ -->
      <div class="mb-8">
        <h2 class="mb-4 text-2xl font-bold text-gray-900">ğŸ“ å­¦ä¹ è·¯å¾„</h2>
        <div id="courseModulesContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          <!-- è¯¾ç¨‹å¡ç‰‡å°†ç”± React æ¸²æŸ“ -->
        </div>
      </div>

      <!-- æ¯æ—¥æŒ‘æˆ˜ -->
      <div class="mb-8">
        <div class="rounded-xl bg-gradient-to-r from-orange-400 to-red-500 p-8 text-white shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="mb-2 flex items-center gap-2 text-2xl font-bold">
                <span>ğŸ”¥</span>
                æ¯æ—¥æŒ‘æˆ˜
              </h3>
              <p class="mb-4 text-white/90">
                å®Œæˆä»Šæ—¥æŒ‘æˆ˜ï¼Œè·å¾—é¢å¤–å¥–åŠ±ï¼
              </p>
              <button class="rounded-lg bg-white px-6 py-2 font-semibold text-orange-600 transition hover:bg-gray-100">
                æ¥å—æŒ‘æˆ˜
              </button>
            </div>
            <div class="hidden text-8xl md:block">ğŸ¯</div>
          </div>
        </div>
      </div>

      <!-- æœ€è¿‘å­¦ä¹  -->
      <div>
        <h2 class="mb-4 text-2xl font-bold text-gray-900">â±ï¸ ç»§ç»­å­¦ä¹ </h2>
        <div id="recentLessonsContainer" class="grid gap-6 md:grid-cols-2">
          <!-- æœ€è¿‘å­¦ä¹ çš„è¯¾ç¨‹ -->
        </div>
      </div>
    </div>

    <!-- AI åŠ©æ•™æµ®åŠ¨æŒ‰é’® -->
    <button
      id="floatingAIBtn"
      class="fixed bottom-6 right-6 z-50 flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-blue-600 text-3xl text-white shadow-2xl transition-all hover:scale-110 hover:shadow-3xl"
      title="AI åŠ©æ•™"
    >
      âœ¨
    </button>
  </div>

  <!-- React ç»„ä»¶å®¹å™¨ -->
  <div id="aiAssistantRoot"></div>
</Layout>

<script>
  // @ts-nocheck
  import { supabase } from '../lib/supabase';

  // ç®€åŒ–ï¼šAI åŠ©æ•™æŒ‰é’®
  document.getElementById('aiAssistantBtn')?.addEventListener('click', () => {
    alert('AI åŠ©æ•™åŠŸèƒ½å¼€å‘ä¸­...');
  });

  document.getElementById('floatingAIBtn')?.addEventListener('click', () => {
    alert('AI åŠ©æ•™åŠŸèƒ½å¼€å‘ä¸­...');
  });

  // åŠ è½½è¯¾ç¨‹æ¨¡å—
  async function loadCourseModules() {
    const container = document.getElementById('courseModulesContainer');
    if (!container) return;

    try {
      const { data: modules, error } = await supabase
        .from('course_modules')
        .select('*')
        .eq('is_published', true)
        .order('order_index');

      if (error) throw error;

      if (modules && modules.length > 0) {
        container.innerHTML = '';
        modules.forEach((module) => {
          const card = document.createElement('div');
          card.className = 'rounded-xl bg-white p-6 shadow-lg transition hover:shadow-xl cursor-pointer';
          card.innerHTML = `
            <div class="text-4xl mb-4">${module.icon || 'ğŸ“š'}</div>
            <h3 class="text-xl font-bold mb-2">${module.title}</h3>
            <p class="text-gray-600 mb-4">${module.description || ''}</p>
            <button class="w-full rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">
              å¼€å§‹å­¦ä¹ 
            </button>
          `;
          card.onclick = () => {
            window.location.href = `/course/${module.slug}`;
          };
          container.appendChild(card);
        });
      } else {
        container.innerHTML = '<p class="text-gray-500">æš‚æ— è¯¾ç¨‹</p>';
      }
    } catch (error) {
      console.error('Error loading courses:', error);
      container.innerHTML = '<p class="text-red-500">åŠ è½½è¯¾ç¨‹å¤±è´¥</p>';
    }
  }

  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  async function updateStats() {
    // ç®€åŒ–ï¼šæ˜¾ç¤ºé»˜è®¤å€¼
    const stats = {
      completedLessons: 0,
      completedChallenges: 0,
      totalXP: 0,
      totalAchievements: 0
    };
    
    document.getElementById('completedLessons').textContent = stats.completedLessons.toString();
    document.getElementById('completedChallenges').textContent = stats.completedChallenges.toString();
    document.getElementById('totalXP').textContent = stats.totalXP.toString();
    document.getElementById('totalAchievements').textContent = stats.totalAchievements.toString();
  }

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    loadCourseModules();
    updateStats();
  });
</script>

