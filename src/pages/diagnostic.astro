---
import Layout from '../components/Layout.astro';
---

<Layout title="ç³»ç»Ÿè¯Šæ–­ - GameCode Lab">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="mx-auto max-w-4xl px-4">
      <div class="rounded-2xl bg-white p-8 shadow-lg">
        <h1 class="mb-6 text-3xl font-bold text-gray-900">ğŸ”§ ç³»ç»Ÿè¯Šæ–­</h1>
        
        <div class="mb-6">
          <button 
            id="runDiagnostic" 
            class="rounded-lg bg-blue-600 px-6 py-3 font-semibold text-white transition hover:bg-blue-700"
          >
            è¿è¡Œè¯Šæ–­æµ‹è¯•
          </button>
        </div>

        <div id="diagnosticResults" class="space-y-4"></div>
      </div>

      <!-- ä¿®å¤æŒ‡å— -->
      <div id="fixGuide" class="mt-8 hidden rounded-2xl bg-yellow-50 p-8 shadow-lg">
        <h2 class="mb-4 text-2xl font-bold text-yellow-900">ğŸ“‹ ä¿®å¤æŒ‡å—</h2>
        <div id="fixInstructions"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // @ts-nocheck
  const button = document.getElementById('runDiagnostic');
  const results = document.getElementById('diagnosticResults');
  const fixGuide = document.getElementById('fixGuide');
  const fixInstructions = document.getElementById('fixInstructions');

  button?.addEventListener('click', async () => {
    results.innerHTML = '<div class="text-gray-600">æ­£åœ¨è¿è¡Œè¯Šæ–­...</div>';
    
    try {
      const response = await fetch('/api/health');
      const data = await response.json();
      
      let html = '<div class="space-y-4">';
      
      // çŠ¶æ€
      html += `
        <div class="flex items-center gap-3 rounded-lg border p-4 ${data.status === 'ok' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
          <div class="text-2xl">${data.status === 'ok' ? 'âœ…' : 'âŒ'}</div>
          <div>
            <div class="font-semibold ${data.status === 'ok' ? 'text-green-900' : 'text-red-900'}">
              ${data.status === 'ok' ? 'æ•°æ®åº“è¿æ¥æ­£å¸¸' : 'æ•°æ®åº“è¿æ¥å¤±è´¥'}
            </div>
          </div>
        </div>
      `;
      
      // Supabase URL
      html += `
        <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
          <div class="mb-2 font-semibold text-gray-900">Supabase URL</div>
          <code class="text-sm text-gray-700">${data.supabaseUrl}</code>
        </div>
      `;
      
      // API Key
      html += `
        <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
          <div class="mb-2 font-semibold text-gray-900">Supabase API Key</div>
          <div class="${data.supabaseKeyExists ? 'text-green-600' : 'text-red-600'}">
            ${data.supabaseKeyExists ? 'âœ“ å·²è®¾ç½®' : 'âœ— æœªè®¾ç½®'}
          </div>
        </div>
      `;
      
      // é”™è¯¯è¯¦æƒ…
      if (data.databaseError) {
        html += `
          <div class="rounded-lg border border-red-200 bg-red-50 p-4">
            <div class="mb-2 font-semibold text-red-900">æ•°æ®åº“é”™è¯¯</div>
            <div class="space-y-2 text-sm">
              <div><span class="font-medium">é”™è¯¯ä»£ç :</span> ${data.databaseError.code}</div>
              <div><span class="font-medium">é”™è¯¯ä¿¡æ¯:</span> ${data.databaseError.message}</div>
              ${data.databaseError.hint ? `<div><span class="font-medium">æç¤º:</span> ${data.databaseError.hint}</div>` : ''}
            </div>
          </div>
        `;
        
        // æ˜¾ç¤ºä¿®å¤æŒ‡å—
        fixGuide.classList.remove('hidden');
        
        if (data.databaseError.code === '42P01') {
          fixInstructions.innerHTML = `
            <div class="space-y-4 text-yellow-900">
              <p class="font-semibold">âŒ é”™è¯¯: æ•°æ®åº“è¡¨ä¸å­˜åœ¨ (${data.databaseError.message})</p>
              
              <div class="rounded-lg bg-white p-4">
                <p class="mb-2 font-semibold">âœ… è§£å†³æ–¹æ¡ˆ: è¿è¡Œæ•°æ®åº“è¿ç§»</p>
                <ol class="list-decimal space-y-2 pl-5">
                  <li>è®¿é—® Supabase Dashboard: <a href="https://app.supabase.com" class="text-blue-600 underline" target="_blank">https://app.supabase.com</a></li>
                  <li>é€‰æ‹©æ‚¨çš„é¡¹ç›®</li>
                  <li>ç‚¹å‡»å·¦ä¾§ <strong>"SQL Editor"</strong></li>
                  <li>ç‚¹å‡» <strong>"New Query"</strong></li>
                  <li>æ‰“å¼€æœ¬åœ°æ–‡ä»¶: <code class="rounded bg-gray-200 px-2 py-1">supabase/migrations/20250415000000_gamecode_lab_schema.sql</code></li>
                  <li>å¤åˆ¶å…¨éƒ¨å†…å®¹ç²˜è´´åˆ° SQL Editor</li>
                  <li>ç‚¹å‡»å³ä¸‹è§’ç»¿è‰² <strong>"Run"</strong> æŒ‰é’®</li>
                  <li>ç­‰å¾… 10-15 ç§’ï¼Œçœ‹åˆ° "Success" å³å®Œæˆ</li>
                  <li>åˆ·æ–°æ­¤é¡µé¢å¹¶é‡æ–°è¿è¡Œè¯Šæ–­</li>
                </ol>
              </div>

              <div class="rounded-lg border-2 border-yellow-400 bg-yellow-100 p-4">
                <p class="font-semibold">âš ï¸ æ£€æŸ¥ Supabase URL</p>
                <p class="mt-2">å½“å‰ä½¿ç”¨çš„ URL: <code class="rounded bg-white px-2 py-1">${data.supabaseUrl}</code></p>
                <p class="mt-2">è¯·ç¡®è®¤è¿™æ˜¯æ­£ç¡®çš„ Supabase é¡¹ç›®URLã€‚å¦‚æœä¸æ­£ç¡®ï¼Œè¯·åœ¨ Netlify ä¸­æ›´æ–°ç¯å¢ƒå˜é‡ã€‚</p>
              </div>
            </div>
          `;
        } else {
          fixInstructions.innerHTML = `
            <div class="space-y-4 text-yellow-900">
              <p class="font-semibold">é‡åˆ°é”™è¯¯: ${data.databaseError.message}</p>
              <p>è¯·è”ç³»ç®¡ç†å‘˜æˆ–æŸ¥çœ‹ Supabase æ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
            </div>
          `;
        }
      } else {
        fixGuide.classList.add('hidden');
      }
      
      html += '</div>';
      results.innerHTML = html;
      
    } catch (error) {
      results.innerHTML = `
        <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-red-900">
          <div class="font-semibold">è¯Šæ–­å¤±è´¥</div>
          <div class="mt-2 text-sm">${error.message}</div>
        </div>
      `;
    }
  });
</script>

